---
title: "Axumã§OpenID Connectã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ã¿ãŸ"
emoji: "ğŸ¦€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust"]
published: false
---

# ã¯ã˜ã‚ã«
æœ€è¿‘ã€ç´ äººã®æ‰‹ç¿’ã„ã§Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æŠ€è¡“ã‚’å‹‰å¼·ã—ã¦ã„ã¾ã™ã€‚

Webã‚µã‚¤ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã„ã¨æ€ã£ãŸæ™‚ã«ã€Basicèªè¨¼ã‹[OpenID Connect](https://openid.net/connect/)(OIDC)ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

Basicèªè¨¼ã«ã¤ã„ã¦èª¿ã¹ãŸã¨ã“ã‚ã€ã‚»ã‚­ãƒ¥ã‚¢ã«å®Ÿè£…ã™ã‚‹ã®ã¯éå¸¸ã«é›£ã—ãã†ã§ã™ã€‚ãªã®ã§OpenID Connectã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…ã«ã¤ã„ã¦å‹‰å¼·ã—ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

ã“ã®è¨˜äº‹ã§ã¯[Axum](https://github.com/tokio-rs/axum)+[openid](https://github.com/kilork/openid)ã‚¯ãƒ¬ãƒ¼ãƒˆã§å®Ÿè£…ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãªãŒã‚‰OIDCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å‹•ä½œã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã¯[ä»¥ä¸‹](https://github.com/hayao0727/oidc_rust)ã«ã‚ã‚Šã¾ã™ã€‚[warp](https://github.com/seanmonstar/warp)+`openid`ã‚¯ãƒ¬ãƒ¼ãƒˆã§å®Ÿè£…ã—ãŸ[ã‚³ãƒ¼ãƒ‰](https://github.com/kilork/openid-examples/blob/v0.9/examples/warp.rs)ã‚’åŸºã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

# OpenID Connectã¨ã¯
OpenID Conent(OIDC)ã¨ã¯[OAuth 2.0](https://openid-foundation-japan.github.io/rfc6749.ja.html)ã®ä¸Šã§æ§‹ç¯‰ã•ã‚ŒãŸèªè¨¼ã®ãŸã‚ã®æŠ€è¡“ä»•æ§˜ã§ã™ã€‚
ã¾ãšãã‚‚ãã‚‚OpenID Connectã£ã¦ãªã«ï¼Ÿã¨ã„ã†äººã¯ä»¥ä¸‹ã®[è¨˜äº‹](https://qiita.com/TakahikoKawasaki/items/498ca08bbfcc341691fe)ã‚’å¾¡è¦§ãã ã•ã„ã€‚

# å‰æ
ã“ã®ã‚³ãƒ¼ãƒ‰ã¯Google OpenId Connectã§å‹•ä½œã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
å‹•ä½œã•ã›ã‚‹ã«ã¯äº‹å‰ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å…¥æ‰‹ã—ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã®ç™»éŒ²ã‚‚å¿…è¦ã§ã™ã€‚

# ç™»å ´äººç‰©
ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚‹Webã‚µã‚¤ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã„ã¨ã„ã†çŠ¶æ³ã‚’æƒ³å®šã—ã¦ãã ã•ã„ã€‚OpenID Connectã‚’ä½¿ã†å ´åˆã€ç™»å ´äººç‰©ãŒ3äººå‡ºã¦ãã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶(ãƒ¦ãƒ¼ã‚¶ãƒ¼)ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ(Webã‚µã‚¤ãƒˆ)ã€IdPã§ã™ã€‚

## ãƒ–ãƒ©ã‚¦ã‚¶
ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è‡ªåˆ†ãŒèª°ãªã®ã‹ã‚’è¨¼æ˜(èªè¨¼)ã—ãŸã„ã§ã™ã€‚

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ä¾‹ãˆã°ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚µã‚¤ãƒˆã§ãƒ–ãƒ©ã‚¦ã‚¶ãŒèª°ãªã®ã‹ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã€‚

## IdP
IdPã¯ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã¯ã€‡ã€‡ã‚„ã§ã€ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ•™ãˆã¦ãã‚Œã‚‹äººã§ã™ã€‚
Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã€Facebookã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãªã©ã®è¡¨ç¤ºã‚’è¦‹ãŸã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ã‚ã‚Œã§ã„ã†Googleã‚„FacebookãŒIdPã§ã™ã€‚

# Open ID Connectã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³
OpenID Connectã‚’ä½¿ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã‚’ç¤ºã—ã¾ã™ã€‚
ã“ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã§æŒ¯ã£ãŸç•ªå·ã¨å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’çªãåˆã‚ã›ãªãŒã‚‰è§£èª¬ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

![](/images/oidc.png)

# 1. ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒª 2. JWKã‚»ãƒƒãƒˆ
OIDCã§ã¯æœ€çµ‚çš„ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª°ã§ã‚ã‚‹ã‹ã‚’è¡¨ã™IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’IdPã‹ã‚‰å—ã‘å–ã‚Šã¾ã™ã€‚
ãã®IDãƒˆãƒ¼ã‚¯ãƒ³ã¯ç½²åã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®ç½²åã®æ¤œè¨¼ã«å¿…è¦ãªæƒ…å ±ã‚’IdPã‹ã‚‰äº‹å‰ã«å–å¾—ã—ã¦ã„ã¾ã™ã€‚
[JWKã‚»ãƒƒãƒˆ](https://tex2e.github.io/rfc-translater/html/rfc7517.html)ã¨ã„ã†JWKã®ã‚»ãƒƒãƒˆã‚’è¡¨ã™JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦è¿”ã•ã‚Œã‚‹ã¿ãŸã„ã§ã™ã€‚
JWKã‚»ãƒƒãƒˆã¯openidã‚¯ãƒ¬ãƒ¼ãƒˆã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹Clientæ§‹é€ ä½“ã«ä¿æŒã•ã‚Œã¾ã™ã€‚
`openid`ã‚¯ãƒ¬ãƒ¼ãƒˆã¯Clientæ§‹é€ ä½“ãŒèªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™ºè¡Œã‚„ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™ºè¡Œã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã¦ãã‚Œã‚’å‘¼ã³å‡ºã—ã¦å‡¦ç†ã‚’é€²ã‚ã‚‹ã¨ã„ã†ã¤ãã‚Šã«ãªã£ã¦ã„ã¾ã™ã€‚

```rust: ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒª
#[tokio::main]
async fn main() {
    // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰idã¨secretã‚’å–å¾—
    let client_id = std::env::var("CLIENT_ID").expect("Unspecified CLIENT_ID as env var");
    let client_secret =
        std::env::var("CLIENT_SECRET").expect("Unspecified CLIENT_SECRET as env var");
    // ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã‚’æŠ•ã’ã‚‹URL
    let issuer_url = std::env::var("ISSURE").unwrap_or("https://accounts.google.com".to_string());
    let issuer = reqwest::Url::parse(&issuer_url).unwrap();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦æ¬²ã—ã„URL
    let redirect = Some(host("/login/oauth2/code/oidc"));

    // ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã—ã¦JWKã‚»ãƒƒãƒˆã‚’å–å¾—
    let client = Arc::new(
        DiscoveredClient::discover(client_id, client_secret, redirect, issuer)
            .await
            .unwrap(), 
    );
    //....
}
```

```rust:Clientæ§‹é€ ä½“
#[derive(Debug)]
pub struct Client<P = Discovered, C: CompactJson + Claims = StandardClaims> {
    /// OAuth provider.
    pub provider: P,

    /// Client ID.
    pub client_id: String,

    /// Client secret.
    pub client_secret: String,

    /// Redirect URI.
    pub redirect_uri: Option<String>,

    pub http_client: reqwest::Client,

    /// JWK SET 
    pub jwks: Option<JWKSet<Empty>>,
    marker: PhantomData<C>,
}

```
https://github.com/kilork/openid ã‹ã‚‰å¼•ç”¨

# 3. èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ 4. èªå¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹
èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å¤§é›‘æŠŠã«ã„ã†ã¨ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€ŒIdPã«ãŠå‰ãŒã ã‚Œã‹è¨¼æ˜ã—ã¦ãªã€ã¨è¨€ã£ã¦ã€IdPã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™ã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ä»‹ã—ã¦IdPã«èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¾ã™ã€‚
èªè¨¼ãŒæˆåŠŸã™ã‚‹ã¨èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è¨­å®šã—ã¦ãŠã„ãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«èªå¯ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚“ã èªå¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚
ã“ã®èªå¯ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’é…’tpåŒºã—ã¾ã™ã€‚
èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¤ã„ã¦ã¯[ä»¥ä¸‹](https://openid-foundation-japan.github.io/rfc6749.ja.html#code-authz-req)ã‚’å‚ç…§ãã ã•ã„ã€‚

```rust
pub async fn authorize(
    Extension(oidc_client): Extension<Arc<OpenIDClient>>, // oidc_clientã¯ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã§ç”Ÿæˆã—ãŸClientæ§‹é€ ä½“
) -> (StatusCode, HeaderMap) {
    // èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ§‹æˆ
    // è©³ç´°ã¯openidã‚¯ãƒ¬ãƒ¼ãƒˆã®auth_urlã®å®Ÿè£…ã‚’å‚ç…§
    let origin_url = std::env::var("ORIGIN").unwrap_or(host(""));
    let auth_url = oidc_client.auth_url(&Options {
        scope: Some("openid email profile".into()),
        state: Some(origin_url),
        ..Default::default()
    });
    let url = String::from(auth_url);

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®š
    let mut headers = HeaderMap::new();
    let val = if let Ok(val) = HeaderValue::from_str(&url) {
        val
    } else {
        return (StatusCode::INTERNAL_SERVER_ERROR, headers);
    };
    headers.insert(http::header::LOCATION, val);

    (StatusCode::FOUND, headers)
}
```


# 5.ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ 6. ãƒˆãƒ¼ã‚¯ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯èªå¯ã‚³ãƒ¼ãƒ‰ã‚’æ‰‹ã«å…¥ã‚ŒãŸã®ã§ãã‚Œã‚’ä½¿ã£ã¦ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºè¡Œã—ã¦ã€IdPã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
pub async fn login(
    Extension(oidc_client): Extension<Arc<OpenIDClient>>,
    login_query: Query<LoginQuery>, //ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èªå¯ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
) -> impl IntoResponse {
    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    let request_token = request_token(oidc_client, &login_query).await;
    match request_token {
        Ok(Some((token, user_info))) => {
            let login = user_info.preferred_username.clone();
            let email = user_info.email.clone();

            let user = User {
                id: user_info.sub.clone().unwrap_or_default(),
                login,
                last_name: user_info.family_name.clone(),
                first_name: user_info.name.clone(),
                email,
                activated: user_info.email_verified,
                image_url: user_info.picture.clone().map(|x| x.to_string()),
                lang_key: Some("en".to_string()),
                authorities: vec!["ROLE_USER".to_string()],
            };
            //....
    }
}

async fn request_token(
    oidc_client: Arc<OpenIDClient>,
    login_query: &LoginQuery,
) -> anyhow::Result<Option<(Token, Userinfo)>> {
    let mut token: Token = oidc_client.request_token(&login_query.code).await?.into(); // ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

    if let Some(mut id_token) = token.id_token.as_mut() {
        oidc_client.decode_token(&mut id_token)?; //ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
        oidc_client.validate_token(&id_token, None, None)?; //ã€€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒãƒªãƒ‡ãƒ¼ãƒˆ
    } else {
        return Ok(None);
    }

    let userinfo = oidc_client.request_userinfo(&token).await?;

    Ok(Some((token, userinfo)))
}
```


# æ‰€æ„Ÿ
`warp`+`openid`ã®ã‚³ãƒ¼ãƒ‰ã‚’`Axum`+`openid`ã®ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã™ã‚‹ãã‚‰ã„æ¥½å‹ã‚„ã‚ï¼ã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒã€`warp`ã‚‚`Axum`ã‚‚ã‚ˆãçŸ¥ã‚‰ãªã„ã¨ã„ã†ã“ã¨ã‚‚ã‚ã£ã¦ã‚¹ãƒ ãƒ¼ã‚ºã«ã¯è¡Œãã¾ã›ã‚“ã§ã—ãŸã€‚
ãŸã å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã™ã‚‹ã¨ã€OpenID Connectã®èª¬æ˜ã‚’ãŸã èª­ã‚€ã‚ˆã‚Šã‚‚ç†è§£ãŒæ·±ã¾ã£ãŸæ°—ãŒã™ã‚‹ã®ã§ã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã„ã†ã‚„ã‚Šã‹ãŸã¯ä½•ã‹ã‚’ç¿’å¾—ã™ã‚‹æ–¹æ³•ã¨ã—ã¦æœ‰åŠ¹ãªã®ã‹ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚
ã¾ãŸã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã†ã¨æ¯”è¼ƒçš„ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ãŒã€ã‚¯ãƒ¬ãƒ¼ãƒˆå†…ã§ã¯ã‚„ã‚„ã“ã—ã„ã“ã¨ã‚’ã‚„ã£ã¦ã„ã¦ã€OIDCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å‡¦ç†ã‚’ã‚¹ã‚¯ãƒ©ãƒƒãƒã§å®Ÿè£…ã™ã‚‹ã®ã¯é¿ã‘ãŸã»ã†ãŒã„ã„ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚


