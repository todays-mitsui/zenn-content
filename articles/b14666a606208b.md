---
title: "Axumã§OpenID Connectã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ã¿ãŸ"
emoji: "ğŸ¦€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust"]
published: false
---

# ã¯ã˜ã‚ã«
Axumã§ç·´ç¿’ã§ãªã‚“ã‹ã‚¢ãƒ—ãƒªä½œã£ã¦ã¿ãŸã„ãªã¨æ€ã„ã¾ã—ãŸã€‚
ã¾ãšã¯ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã„ã¨æ€ã£ãŸæ™‚ã«ã€Basicèªè¨¼orOpenID Connectã«ãªã‚‹ã®ã‹ã¨æ€ã„ã¾ã—ãŸã€‚

ã‚»ã‚­ãƒ¥ã‚¢ãªBasicèªè¨¼ã‚’å®Ÿè£…ã™ã‚‹ã®ã¯éå¸¸ã«é›£ã—ã„ã‚‰ã—ã„ã®ã§OpenID Connectã‚’å®Ÿè£…ä½¿ç”¨ã¨æ±ºã‚ã¾ã—ãŸã€‚

ã“ã®è¨˜äº‹ã§ã¯Axum+openidã‚¯ãƒ¬ãƒ¼ãƒˆã§å®Ÿè£…ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãªãŒã‚‰OIDCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å‹•ä½œã«ã¤ã„ã¦è§£èª¬ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
ãªãŠã“ã®ã‚³ãƒ¼ãƒ‰ã¯warp+openidã‚¯ãƒ¬ãƒ¼ãƒˆã§å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’åŸºã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

# Open ID Connectã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³
ã¾ãšãã‚‚ãã‚‚Open ID Connectã£ã¦ãªã«ï¼Ÿã¨ã„ã†äººã¯ä»¥ä¸‹ã®[è¨˜äº‹](https://qiita.com/TakahikoKawasaki/items/498ca08bbfcc341691fe)ã‚’å¾¡è¦§ãã ã•ã„ã€‚
ã¾ãšã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã‚’ç¤ºã—ã¾ã™ã€‚
ã“ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã§æŒ¯ã£ãŸç•ªå·ã¨å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’çªãåˆã‚ã›ãªãŒã‚‰è§£èª¬ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

# å‰æ
ã“ã®OpenIdã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯Google OpenId Connectã§å‹•ä½œã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚å‹•ä½œã•ã›ã‚‹ã«ã¯äº‹å‰ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å…¥æ‰‹ã—ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã®ç™»éŒ²ã‚‚å¿…è¦ã§ã™ã€‚

# ç™»å ´äººç‰©

## ãƒ–ãƒ©ã‚¦ã‚¶
ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è‡ªåˆ†ãŒèª°ãªã®ã‹ã‚’è¨¼æ˜ã—ãŸã„ã§ã™ã€‚

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ä¾‹ãˆã°ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚µã‚¤ãƒˆã§ãƒ–ãƒ©ã‚¦ã‚¶ãŒèª°ãªã®ã‹ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã€‚

## IdP
IdPã¯ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã€‡ã€‡ã‚„ã§ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ•™ãˆã¦ãã‚Œã‚‹äººã§ã™ã€‚


# 1.ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒª
æœ€çµ‚çš„ã«IdPã‹ã‚‰å—ã‘å–ã‚‹IDãƒˆãƒ¼ã‚¯ãƒ³ã¯ç½²åã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®ç½²åã®æ¤œè¨¼ã«å¿…è¦ãªæƒ…å ±ã‚’IdPã‹ã‚‰äº‹å‰ã«å–å¾—ã—ã¦ã„ã¾ã™ã€‚JWKã‚»ãƒƒãƒˆæ–‡æ›¸ã¨å‘¼ã°ã‚Œã¦ã„ã‚‹ã¿ãŸã„ã§ãšã€‚
ãã®å€¤ã¯openidã‚¯ãƒ¬ãƒ¼ãƒˆã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹Clientæ§‹é€ ä½“ã«ä¿æŒã•ã‚Œã¾ã™ã€‚
```rust
#[tokio::main]
async fn main() {
    let client_id = std::env::var("CLIENT_ID").expect("Unspecified CLIENT_ID as env var");
    let client_secret =
        std::env::var("CLIENT_SECRET").expect("Unspecified CLIENT_SECRET as env var");
    let issuer_url = std::env::var("ISSURE").unwrap_or("https://accounts.google.com".to_string());
    let redirect = Some(host("/login/oauth2/code/oidc"));
    let issuer = reqwest::Url::parse(&issuer_url).unwrap();

    let client = Arc::new(
        DiscoveredClient::discover(client_id, client_secret, redirect, issuer)
            .await
            .unwrap(), // ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒª
    );
    //....
}
```

```rust:Clientæ§‹é€ ä½“
#[derive(Debug)]
pub struct Client<P = Discovered, C: CompactJson + Claims = StandardClaims> {
    /// OAuth provider.
    pub provider: P,

    /// Client ID.
    pub client_id: String,

    /// Client secret.
    pub client_secret: String,

    /// Redirect URI.
    pub redirect_uri: Option<String>,

    pub http_client: reqwest::Client,

    pub jwks: Option<JWKSet<Empty>>,
    marker: PhantomData<C>,
}

```
https://github.com/kilork/openid ã‹ã‚‰å¼•ç”¨

# 2.èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å¤§é›‘æŠŠã«ã„ã†ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€ŒIdPã«ãŠå‰ãŒã ã‚Œã‹è¨¼æ˜ã—ã¦ãªã€ã¨è¨€ã£ã¦ã€IdPã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™ã€‚
èªè¨¼ãŒæˆåŠŸã™ã‚‹ã¨èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è¨­å®šã—ã¦ãŠã„ãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚³ãƒ¼ãƒ‰å€¤ã‚’ã‚‚ã£ã¦ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚

```rust
pub async fn authorize(
    Extension(oidc_client): Extension<Arc<OpenIDClient>>, // oidc_clientã¯ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã§ç”Ÿæˆã—ãŸClientæ§‹é€ ä½“
) -> (StatusCode, HeaderMap) {
    let origin_url = std::env::var("ORIGIN").unwrap_or(host(""));
    let auth_url = oidc_client.auth_url(&Options {
        scope: Some("openid email profile".into()),
        state: Some(origin_url),
        ..Default::default()
    });
    let url = String::from(auth_url);

    let mut headers = HeaderMap::new();
    let val = if let Ok(val) = HeaderValue::from_str(&url) {
        val
    } else {
        return (StatusCode::INTERNAL_SERVER_ERROR, headers);
    };
    headers.insert(http::header::LOCATION, val);

    (StatusCode::FOUND, headers)
}
```

ã“ã“ã¯urlã‚’ç”Ÿæˆã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã¨ã„ã†æ„Ÿã˜ã§ã™ã­ã€‚

# 3.ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
ã“ã®æ™‚ç‚¹ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯codeã€client_idã€client_secretã€redirect_urlã‚’æŒã£ã¦ã„ã‚‹ã®ã§ãã‚Œã‚’ä½¿ã£ã¦ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºè¡Œã—ã¾ã™ã€ãã†ã™ã‚‹ã¨IdPã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
pub async fn login(
    Extension(oidc_client): Extension<Arc<OpenIDClient>>,
    login_query: Query<LoginQuery>, //ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®codeå€¤ã‚’å–å¾—
) -> impl IntoResponse {
    let request_token = request_token(oidc_client, &login_query).await;
    match request_token {
        Ok(Some((token, user_info))) => {
            let login = user_info.preferred_username.clone();
            let email = user_info.email.clone();

            let user = User {
                id: user_info.sub.clone().unwrap_or_default(),
                login,
                last_name: user_info.family_name.clone(),
                first_name: user_info.name.clone(),
                email,
                activated: user_info.email_verified,
                image_url: user_info.picture.clone().map(|x| x.to_string()),
                lang_key: Some("en".to_string()),
                authorities: vec!["ROLE_USER".to_string()],
            };
            //....
    }
}

async fn request_token(
    oidc_client: Arc<OpenIDClient>,
    login_query: &LoginQuery,
) -> anyhow::Result<Option<(Token, Userinfo)>> {
    let mut token: Token = oidc_client.request_token(&login_query.code).await?.into(); // ãƒˆãƒ¼ã‚¯ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

    if let Some(mut id_token) = token.id_token.as_mut() {
        oidc_client.decode_token(&mut id_token)?; //ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
        oidc_client.validate_token(&id_token, None, None)?; //ã€€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒãƒªãƒ‡ãƒ¼ãƒˆ
    } else {
        return Ok(None);
    }

    let userinfo = oidc_client.request_userinfo(&token).await?;

    Ok(Some((token, userinfo)))
}
```


# æ‰€æ„Ÿ
warp+openidã®ã‚³ãƒ¼ãƒ‰ã‚’axum+openidã®ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã™ã‚‹ãã‚‰ã„æ¥½å‹ã‚„ã‚ï¼ã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒã€warpã‚‚Axumã‚‚ã‚ˆãçŸ¥ã‚‰ãªã„ã¨ã„ã†ã“ã¨ã‚‚ã‚ã£ã¦ã‚¹ãƒ ãƒ¼ã‚ºã«ã¯è¡Œãã¾ã›ã‚“ã§ã—ãŸã€‚ãŸã å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã™ã‚‹ã¨ã€OpenID Connectã®èª¬æ˜ã‚’ãŸã èª­ã‚€ã‚ˆã‚Šã‚‚ç†è§£ãŒã¾ã—ãŸæ°—ãŒã™ã‚‹ã®ã§å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã„ã†ã‚„ã‚Šã‹ãŸã¯ä½•ã‹ã‚’ç¿’å¾—ã™ã‚‹æ–¹æ³•ã¨ã—ã¦æœ‰åŠ¹ãªã®ã‹ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚
ã¾ãŸã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã†ã¨æ¯”è¼ƒçš„ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ãŒã€ã‚¯ãƒ¬ãƒ¼ãƒˆå†…ã§ã¯ã‚„ã‚„ã“ã—ã„ã“ã¨ã‚’ã‚„ã£ã¦ã„ã¦ã€oidcã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å‡¦ç†ã‚’ã‚¹ã‚¯ãƒ©ãƒƒãƒã§å®Ÿè£…ã™ã‚‹ã®ã¯é¿ã‘ãŸã»ã†ãŒã„ã„ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚


